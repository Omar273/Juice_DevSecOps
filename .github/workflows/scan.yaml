name: DevSecOps Pipeline - FIXED (SAST + DAST + SCA)

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

env:
  JUICE_SHOP_IMAGE: bkimminich/juice-shop
  JUICE_SHOP_PORT: 3000

jobs:
# =========================
# 1Ô∏è‚É£ BUILD
# =========================
  build:
    name: Build & Checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Build step
        run: echo "Build completed"

# =========================
# 2Ô∏è‚É£ SCA - DEPENDENCY SCANNING
# =========================
  sca-dependency-check:
    name: SCA - OWASP Dependency Check
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Juice Shop
        run: |
          git clone --depth 1 https://github.com/juice-shop/juice-shop.git juice-shop-repo
          cd juice-shop-repo
          npm install --package-lock-only || true
      - name: Run Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'juice-shop'
          path: './juice-shop-repo'
          format: 'XML'
          args: '--enableRetired --enableExperimental'
        continue-on-error: true
      - name: Verify Report
        run: |
          if [ ! -f reports/dependency-check-report.xml ]; then
            mkdir -p reports
            echo '<?xml version="1.0"?><analysis></analysis>' > reports/dependency-check-report.xml
          fi
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/dependency-check-report.xml
        if: always()

  sca-trivy:
    name: SCA - Trivy
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'bkimminich/juice-shop:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        continue-on-error: true
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-results.json
        if: always()

# =========================
# 3Ô∏è‚É£ SAST - CODE SCANNING
# =========================
  sast-semgrep:
    name: SAST - Semgrep
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Juice Shop
        run: git clone --depth 1 https://github.com/juice-shop/juice-shop.git juice-shop-repo
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Semgrep
        run: pip install semgrep
      - name: Run Semgrep
        run: |
          cd juice-shop-repo
          semgrep scan \
            --config=p/security-audit \
            --config=p/nodejs \
            --config=p/javascript \
            --config=p/owasp-top-ten \
            --config=p/sql-injection \
            --config=p/xss \
            --json . > ../semgrep.json || true
      - name: Show Summary
        run: |
          FINDINGS=$(python3 -c "import json; d=json.load(open('semgrep.json')); print(len(d.get('results', [])))" || echo "0")
          echo "üéØ Semgrep findings: $FINDINGS"
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.json

  sast-nodejsscan:
    name: SAST - NodeJsScan
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Juice Shop
        run: git clone --depth 1 https://github.com/juice-shop/juice-shop.git juice-shop-repo
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install NodeJsScan
        run: pip install nodejsscan
      - name: Run NodeJsScan
        run: nodejsscan --directory juice-shop-repo --output nodejsscan.json || echo '{}' > nodejsscan.json
        continue-on-error: true
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: nodejsscan-report
          path: nodejsscan.json

# =========================
# 4Ô∏è‚É£ DAST - WEB SCANNING
# =========================
  dast-zap:
    name: DAST - OWASP ZAP
    needs: [sast-semgrep, sca-trivy]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create network
        run: docker network create zap-net
      - name: Run Juice Shop
        run: |
          docker run -d --name juice-shop --network zap-net -p 3000:3000 ${{ env.JUICE_SHOP_IMAGE }}
          sleep 60
      - name: Fix permissions
        run: chmod -R 777 "$(pwd)"
      - name: Create URL seeds
        run: |
          cat > urls.txt << 'EOF'
          http://juice-shop:3000/
          http://juice-shop:3000/#/login
          http://juice-shop:3000/#/search
          http://juice-shop:3000/#/basket
          http://juice-shop:3000/#/administration
          http://juice-shop:3000/api/Users
          http://juice-shop:3000/api/Products
          http://juice-shop:3000/rest/user/login
          http://juice-shop:3000/rest/products/search
          EOF
      - name: Run ZAP Scan
        run: |
          docker run --rm --user root --network zap-net -v $(pwd):/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable bash -c "
              zap.sh -daemon -host 0.0.0.0 -port 8080 \
                -config api.disablekey=true \
                -config api.addrs.addr.name=.* \
                -config api.addrs.addr.regex=true &
              sleep 20
              
              while read url; do
                curl -s \"http://localhost:8080/JSON/core/action/accessUrl/?url=\$url\" > /dev/null
              done < /zap/wrk/urls.txt
              sleep 10
              
              SPIDER=\$(curl -s 'http://localhost:8080/JSON/spider/action/scan/?url=http://juice-shop:3000' | jq -r '.scan')
              while true; do
                STATUS=\$(curl -s \"http://localhost:8080/JSON/spider/view/status/?scanId=\$SPIDER\" | jq -r '.status')
                [ \"\$STATUS\" = \"100\" ] && break
                sleep 5
              done
              
              curl -s 'http://localhost:8080/JSON/ajaxSpider/action/scan/?url=http://juice-shop:3000' > /dev/null
              sleep 300
              
              sleep 10
              while true; do
                REM=\$(curl -s 'http://localhost:8080/JSON/pscan/view/recordsToScan/' | jq -r '.recordsToScan')
                [ \"\$REM\" = \"0\" ] && break
                sleep 5
              done
              
              curl -s 'http://localhost:8080/JSON/ascan/action/enableAllScanners/' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionAttackStrength/?String=INSANE' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionAlertThreshold/?String=LOW' > /dev/null
              
              ASCAN=\$(curl -s 'http://localhost:8080/JSON/ascan/action/scan/?url=http://juice-shop:3000&recurse=true' | jq -r '.scan')
              while true; do
                STATUS=\$(curl -s \"http://localhost:8080/JSON/ascan/view/status/?scanId=\$ASCAN\" | jq -r '.status')
                [ \"\$STATUS\" = \"100\" ] && break
                sleep 15
              done
              
              ALERTS=\$(curl -s 'http://localhost:8080/JSON/core/view/numberOfAlerts/' | jq -r '.numberOfAlerts')
              echo \"üéØ TOTAL FINDINGS: \$ALERTS\"
              
              curl -s 'http://localhost:8080/OTHER/core/other/xmlreport/' -o /zap/wrk/zap.xml
              curl -s 'http://localhost:8080/OTHER/core/other/htmlreport/' -o /zap/wrk/zap.html
            "
        timeout-minutes: 90
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap.xml
            zap.html
        if: always()
      - name: Show Summary
        run: |
          if [ -f zap.xml ]; then
            TOTAL=$(grep -c '<alertitem>' zap.xml || echo "0")
            HIGH=$(grep -c '<riskcode>3</riskcode>' zap.xml || echo "0")
            MEDIUM=$(grep -c '<riskcode>2</riskcode>' zap.xml || echo "0")
            echo "üéØ Total: $TOTAL (High: $HIGH, Medium: $MEDIUM)"
          fi
        if: always()
      - name: Cleanup
        if: always()
        run: |
          docker stop juice-shop || true
          docker rm juice-shop || true
          docker network rm zap-net || true

  dast-nuclei:
    name: DAST - Nuclei
    needs: sast-semgrep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Juice Shop
        run: |
          docker run -d --name juice-shop -p 3000:3000 ${{ env.JUICE_SHOP_IMAGE }}
          sleep 60
      - name: Run Nuclei
        uses: projectdiscovery/nuclei-action@v3
        with:
          target: http://localhost:3000
          output: nuclei-results.txt
        continue-on-error: true
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-report
          path: nuclei-results.txt
        if: always()
      - name: Cleanup
        if: always()
        run: docker stop juice-shop && docker rm juice-shop || true

# =========================
# 5Ô∏è‚É£ DEFECTDOJO UPLOAD
# =========================
  defectdojo:
    name: Upload to DefectDojo
    needs: [sast-semgrep, sast-nodejsscan, dast-zap, sca-dependency-check, sca-trivy]
    runs-on: ubuntu-latest
    if: always()
    env:
      DD_URL: ${{ secrets.DEFECTDOJO_URL }}
      DD_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports
      
      - name: List Files
        run: find reports -type f
      
      - name: Upload Semgrep
        continue-on-error: true
        run: |
          if [ -f reports/semgrep-report/semgrep.json ]; then
            curl -v -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_KEY" \
              -F "scan_type=Semgrep JSON Report" \
              -F "file=@reports/semgrep-report/semgrep.json" \
              -F "product_name=DevSecOps_Project" \
              -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
              -F "test_title=Semgrep SAST Scan" \
              -F "auto_create_context=true" \
              -F "active=true" \
              -F "verified=false" 2>&1 | tee semgrep.log
            grep -q '"id":' semgrep.log && echo "‚úÖ Semgrep uploaded" || echo "‚ùå Semgrep failed"
          fi
      
      - name: Upload ZAP
        continue-on-error: true
        run: |
          if [ -f reports/zap-reports/zap.xml ]; then
            curl -v -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_KEY" \
              -F "scan_type=ZAP Scan" \
              -F "file=@reports/zap-reports/zap.xml" \
              -F "product_name=DevSecOps_Project" \
              -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
              -F "test_title=OWASP ZAP DAST Scan" \
              -F "auto_create_context=true" \
              -F "active=true" \
              -F "verified=false" 2>&1 | tee zap.log
            grep -q '"id":' zap.log && echo "‚úÖ ZAP uploaded" || echo "‚ùå ZAP failed"
          fi
      
      - name: Upload Trivy
        continue-on-error: true
        run: |
          if [ -f reports/trivy-report/trivy-results.json ]; then
            curl -v -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_KEY" \
              -F "scan_type=Trivy Scan" \
              -F "file=@reports/trivy-report/trivy-results.json" \
              -F "product_name=DevSecOps_Project" \
              -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
              -F "test_title=Trivy SCA Container Scan" \
              -F "auto_create_context=true" \
              -F "active=true" \
              -F "verified=false" 2>&1 | tee trivy.log
            grep -q '"id":' trivy.log && echo "‚úÖ Trivy uploaded" || echo "‚ùå Trivy failed"
          fi
      
      - name: Upload Dependency Check
        continue-on-error: true
        run: |
          if [ -f reports/dependency-check-report/dependency-check-report.xml ]; then
            curl -v -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_KEY" \
              -F "scan_type=Dependency Check Scan" \
              -F "file=@reports/dependency-check-report/dependency-check-report.xml" \
              -F "product_name=DevSecOps_Project" \
              -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
              -F "test_title=OWASP Dependency Check SCA" \
              -F "auto_create_context=true" \
              -F "active=true" \
              -F "verified=false" 2>&1 | tee depcheck.log
            grep -q '"id":' depcheck.log && echo "‚úÖ Dependency Check uploaded" || echo "‚ùå Dependency Check failed"
          fi

# =========================
# 6Ô∏è‚É£ SUMMARY
# =========================
  summary:
    name: üìä Summary
    needs: defectdojo
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          path: reports
      - name: Generate Summary
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  üîí SECURITY SCAN RESULTS         ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          
          if [ -f reports/semgrep-report/semgrep.json ]; then
            S=$(python3 -c "import json; print(len(json.load(open('reports/semgrep-report/semgrep.json')).get('results',[])))" 2>/dev/null || echo "0")
            echo "Semgrep: $S findings"
          fi
          
          if [ -f reports/zap-reports/zap.xml ]; then
            Z=$(grep -c '<alertitem>' reports/zap-reports/zap.xml || echo "0")
            echo "ZAP: $Z findings"
          fi
          
          if [ -f reports/trivy-report/trivy-results.json ]; then
            T=$(jq '[.Results[]?.Vulnerabilities[]?]|length' reports/trivy-report/trivy-results.json 2>/dev/null || echo "0")
            echo "Trivy: $T vulnerabilities"
          fi
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
