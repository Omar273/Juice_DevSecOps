name: DevSecOps Pipeline - ULTRA AGGRESSIVE (Maximum Findings)

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

env:
  JUICE_SHOP_IMAGE: bkimminich/juice-shop
  JUICE_SHOP_PORT: 3000

jobs:
# =========================
# 1ï¸âƒ£ BUILD
# =========================
  build:
    name: Build & Checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Build step
        run: echo "Build completed"

# =========================
# 2ï¸âƒ£ SCA - MAXIMUM COVERAGE
# =========================
  sca-dependency-check:
    name: SCA - OWASP Dependency Check (Aggressive)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Juice Shop
        run: |
          git clone --depth 1 https://github.com/juice-shop/juice-shop.git juice-shop-repo
          cd juice-shop-repo
          npm install || true  # Full install to catch all dependencies
      - name: Run Dependency Check (All Analyzers)
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'juice-shop'
          path: './juice-shop-repo'
          format: 'XML'
          args: >
            --enableRetired
            --enableExperimental
            --nodeAuditAnalyzerEnabled true
            --nodePackageAnalyzerEnabled true
            --retireJsAnalyzerEnabled true
            --ossindexAnalyzerEnabled true
        continue-on-error: true
      - name: Verify Report
        run: |
          if [ ! -f reports/dependency-check-report.xml ]; then
            mkdir -p reports
            echo '<?xml version="1.0"?><analysis></analysis>' > reports/dependency-check-report.xml
          fi
          VULNS=$(grep -c "<vulnerability>" reports/dependency-check-report.xml || echo "0")
          echo "ğŸ“¦ Dependency Check found: $VULNS vulnerabilities"
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/dependency-check-report.xml
        if: always()

  sca-trivy:
    name: SCA - Trivy (All Scanners)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Run Trivy (Image + Filesystem + Config)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'bkimminich/juice-shop:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,config,license'
        continue-on-error: true
      - name: Show Summary
        run: |
          if [ -f trivy-results.json ]; then
            TOTAL=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
            echo "ğŸ“¦ Trivy found: $TOTAL total ($CRITICAL critical, $HIGH high)"
          fi
        if: always()
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-results.json
        if: always()

  sca-npm-audit:
    name: SCA - NPM Audit (Additional)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Juice Shop
        run: git clone --depth 1 https://github.com/juice-shop/juice-shop.git juice-shop-repo
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Run NPM Audit
        run: |
          cd juice-shop-repo
          npm audit --json > ../npm-audit.json || true
          npm audit --json --audit-level=low >> ../npm-audit.json || true
        continue-on-error: true
      - name: Show Summary
        run: |
          if [ -f npm-audit.json ]; then
            VULNS=$(jq '.metadata.vulnerabilities | to_entries | map(.value) | add' npm-audit.json 2>/dev/null || echo "0")
            echo "ğŸ“¦ NPM Audit found: $VULNS vulnerabilities"
          fi
        if: always()
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit.json
        if: always()

# =========================
# 3ï¸âƒ£ SAST - MAXIMUM RULESETS
# =========================
  sast-semgrep-ultra:
    name: SAST - Semgrep (ULTRA - All Rulesets)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Juice Shop
        run: git clone --depth 1 https://github.com/juice-shop/juice-shop.git juice-shop-repo
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Semgrep
        run: pip install semgrep
      - name: Run Semgrep (ALL Security Rulesets)
        run: |
          cd juice-shop-repo
          semgrep scan \
            --config=p/security-audit \
            --config=p/ci \
            --config=p/nodejs \
            --config=p/javascript \
            --config=p/typescript \
            --config=p/owasp-top-ten \
            --config=p/expressjs \
            --config=p/sql-injection \
            --config=p/xss \
            --config=p/command-injection \
            --config=p/insecure-transport \
            --config=p/secrets \
            --config=p/jwt \
            --config=p/csrf \
            --config=p/eslint-plugin-security \
            --config=p/nodejsscan \
            --config=p/clientside \
            --config=p/default \
            --severity=INFO \
            --severity=WARNING \
            --severity=ERROR \
            --json \
            --max-target-bytes=10000000 \
            . > ../semgrep.json || true
        continue-on-error: true
      - name: Show Summary
        run: |
          FINDINGS=$(python3 -c "import json; d=json.load(open('semgrep.json')); print(len(d.get('results', [])))" 2>/dev/null || echo "0")
          echo "ğŸ” Semgrep found: $FINDINGS findings"
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.json
        if: always()

  sast-nodejsscan:
    name: SAST - NodeJsScan
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Juice Shop
        run: git clone --depth 1 https://github.com/juice-shop/juice-shop.git juice-shop-repo
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install NodeJsScan
        run: pip install nodejsscan
      - name: Run NodeJsScan
        run: nodejsscan --directory juice-shop-repo --output nodejsscan.json || echo '{}' > nodejsscan.json
        continue-on-error: true
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: nodejsscan-report
          path: nodejsscan.json
        if: always()

  sast-eslint-security:
    name: SAST - ESLint Security (Additional)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone Juice Shop
        run: git clone --depth 1 https://github.com/juice-shop/juice-shop.git juice-shop-repo
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install ESLint Security
        run: |
          cd juice-shop-repo
          npm install --save-dev \
            eslint \
            eslint-plugin-security \
            eslint-plugin-no-secrets || true
      - name: Run ESLint Security
        run: |
          cd juice-shop-repo
          npx eslint . \
            --plugin security \
            --plugin no-secrets \
            --format json \
            --output-file ../eslint-security.json || true
        continue-on-error: true
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: eslint-security-report
          path: eslint-security.json
        if: always()

# =========================
# 4ï¸âƒ£ DAST - ULTRA AGGRESSIVE
# =========================
  dast-zap-ultra:
    name: DAST - OWASP ZAP (ULTRA AGGRESSIVE)
    needs: [sast-semgrep-ultra, sca-trivy]
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
      - name: Create network
        run: docker network create zap-net
      - name: Run Juice Shop
        run: |
          docker run -d --name juice-shop --network zap-net -p 3000:3000 ${{ env.JUICE_SHOP_IMAGE }}
          sleep 60
      - name: Fix permissions
        run: chmod -R 777 "$(pwd)"
      - name: Create Comprehensive URL Seeds (100+ URLs)
        run: |
          cat > urls.txt << 'EOF'
          http://juice-shop:3000/
          http://juice-shop:3000/#/
          http://juice-shop:3000/#/search
          http://juice-shop:3000/#/login
          http://juice-shop:3000/#/register
          http://juice-shop:3000/#/forgot-password
          http://juice-shop:3000/#/basket
          http://juice-shop:3000/#/contact
          http://juice-shop:3000/#/administration
          http://juice-shop:3000/#/about
          http://juice-shop:3000/#/privacy-security
          http://juice-shop:3000/#/privacy-security/privacy-policy
          http://juice-shop:3000/#/privacy-security/data-export
          http://juice-shop:3000/#/privacy-security/data-erasure
          http://juice-shop:3000/#/privacy-security/last-login-ip
          http://juice-shop:3000/#/privacy-security/request-data-export
          http://juice-shop:3000/#/photo-wall
          http://juice-shop:3000/#/deluxe-membership
          http://juice-shop:3000/#/accounting
          http://juice-shop:3000/#/order-history
          http://juice-shop:3000/#/order-tracking
          http://juice-shop:3000/#/wallet
          http://juice-shop:3000/#/address
          http://juice-shop:3000/#/address/select
          http://juice-shop:3000/#/address/create
          http://juice-shop:3000/#/address/edit
          http://juice-shop:3000/#/payment
          http://juice-shop:3000/#/saved-payment-methods
          http://juice-shop:3000/#/change-password
          http://juice-shop:3000/#/2fa
          http://juice-shop:3000/#/privacy-policy
          http://juice-shop:3000/#/data-export
          http://juice-shop:3000/#/last-login-ip
          http://juice-shop:3000/#/recycle
          http://juice-shop:3000/#/complaint
          http://juice-shop:3000/#/chatbot
          http://juice-shop:3000/#/score-board
          http://juice-shop:3000/#/track-result
          http://juice-shop:3000/#/track-order
          http://juice-shop:3000/#/order-completion
          http://juice-shop:3000/#/delivery-method
          http://juice-shop:3000/#/order-summary
          http://juice-shop:3000/api/Users
          http://juice-shop:3000/api/Users/1
          http://juice-shop:3000/api/Users/2
          http://juice-shop:3000/api/Users/3
          http://juice-shop:3000/api/Products
          http://juice-shop:3000/api/Products/1
          http://juice-shop:3000/api/Products/search
          http://juice-shop:3000/api/Challenges
          http://juice-shop:3000/api/Feedbacks
          http://juice-shop:3000/api/BasketItems
          http://juice-shop:3000/api/Quantitys
          http://juice-shop:3000/api/Cards
          http://juice-shop:3000/api/Addresss
          http://juice-shop:3000/api/SecurityQuestions
          http://juice-shop:3000/api/SecurityAnswers
          http://juice-shop:3000/api/Deliverys
          http://juice-shop:3000/api/Captchas
          http://juice-shop:3000/api/Complaints
          http://juice-shop:3000/api/Recycles
          http://juice-shop:3000/api/Memorys
          http://juice-shop:3000/rest/user/login
          http://juice-shop:3000/rest/user/register
          http://juice-shop:3000/rest/user/whoami
          http://juice-shop:3000/rest/user/reset-password
          http://juice-shop:3000/rest/user/change-password
          http://juice-shop:3000/rest/user/authentication-details
          http://juice-shop:3000/rest/user/data-export
          http://juice-shop:3000/rest/user/erasure-request
          http://juice-shop:3000/rest/products/search
          http://juice-shop:3000/rest/products/1
          http://juice-shop:3000/rest/products/2
          http://juice-shop:3000/rest/products/reviews
          http://juice-shop:3000/rest/basket/1
          http://juice-shop:3000/rest/basket/2
          http://juice-shop:3000/rest/basket/checkout
          http://juice-shop:3000/rest/track-order
          http://juice-shop:3000/rest/continue-code
          http://juice-shop:3000/rest/continue-code-findIt
          http://juice-shop:3000/rest/continue-code-fixIt
          http://juice-shop:3000/rest/continue-code-apply
          http://juice-shop:3000/rest/admin/application-version
          http://juice-shop:3000/rest/admin/application-configuration
          http://juice-shop:3000/rest/deluxe-membership
          http://juice-shop:3000/rest/memories
          http://juice-shop:3000/rest/image-captcha
          http://juice-shop:3000/rest/languages
          http://juice-shop:3000/rest/saveLoginIp
          http://juice-shop:3000/rest/chatbot/status
          http://juice-shop:3000/rest/chatbot/query
          http://juice-shop:3000/rest/2fa/status
          http://juice-shop:3000/rest/2fa/setup
          http://juice-shop:3000/rest/2fa/verify
          http://juice-shop:3000/rest/2fa/disable
          http://juice-shop:3000/ftp
          http://juice-shop:3000/ftp/legal.md
          http://juice-shop:3000/ftp/acquisitions.md
          http://juice-shop:3000/assets
          http://juice-shop:3000/assets/public
          http://juice-shop:3000/redirect
          http://juice-shop:3000/redirect?to=https://github.com
          http://juice-shop:3000/metrics
          http://juice-shop:3000/profile
          http://juice-shop:3000/profile/image
          http://juice-shop:3000/profile/image/file
          http://juice-shop:3000/file-upload
          http://juice-shop:3000/video
          http://juice-shop:3000/snippets
          http://juice-shop:3000/b2b/v2/orders
          EOF
      - name: Run ZAP ULTRA AGGRESSIVE Scan
        run: |
          docker run --rm --user root --network zap-net -v $(pwd):/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable bash -c "
              zap.sh -daemon -host 0.0.0.0 -port 8080 \
                -config api.disablekey=true \
                -config api.addrs.addr.name=.* \
                -config api.addrs.addr.regex=true &
              sleep 25
              
              echo '=== Accessing 100+ URLs ==='
              while read url; do
                curl -s \"http://localhost:8080/JSON/core/action/accessUrl/?url=\$url\" > /dev/null
                sleep 0.5
              done < /zap/wrk/urls.txt
              sleep 15
              
              echo '=== Traditional Spider (Max Depth) ==='
              SPIDER=\$(curl -s 'http://localhost:8080/JSON/spider/action/scan/?url=http://juice-shop:3000&maxChildren=0&recurse=true&subtreeOnly=false' | jq -r '.scan')
              while true; do
                STATUS=\$(curl -s \"http://localhost:8080/JSON/spider/view/status/?scanId=\$SPIDER\" | jq -r '.status')
                echo \"Spider: \$STATUS%\"
                [ \"\$STATUS\" = \"100\" ] && break
                sleep 5
              done
              
              echo '=== AJAX Spider (Extended Time) ==='
              curl -s 'http://localhost:8080/JSON/ajaxSpider/action/scan/?url=http://juice-shop:3000&inScope=&contextName=&subtreeOnly=' > /dev/null
              sleep 600  # Run AJAX spider for 10 minutes
              
              URLS=\$(curl -s 'http://localhost:8080/JSON/core/view/numberOfMessages/' | jq -r '.numberOfMessages')
              echo \"ğŸ“Š Total URLs discovered: \$URLS\"
              
              echo '=== Passive Scan ==='
              sleep 20
              while true; do
                REM=\$(curl -s 'http://localhost:8080/JSON/pscan/view/recordsToScan/' | jq -r '.recordsToScan')
                echo \"Passive scan remaining: \$REM\"
                [ \"\$REM\" = \"0\" ] && break
                sleep 5
              done
              
              PASSIVE=\$(curl -s 'http://localhost:8080/JSON/core/view/numberOfAlerts/' | jq -r '.numberOfAlerts')
              echo \"ğŸ” Passive scan alerts: \$PASSIVE\"
              
              echo '=== Active Scan (INSANE + ALL Rules) ==='
              curl -s 'http://localhost:8080/JSON/ascan/action/enableAllScanners/' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionAttackStrength/?String=INSANE' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionAlertThreshold/?String=LOW' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionThreadPerHost/?Integer=15' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionMaxRuleDurationInMins/?Integer=60' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionMaxScanDurationInMins/?Integer=150' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionMaxAlertsPerRule/?Integer=50' > /dev/null
              curl -s 'http://localhost:8080/JSON/ascan/action/setOptionDelayInMs/?Integer=0' > /dev/null
              
              ASCAN=\$(curl -s 'http://localhost:8080/JSON/ascan/action/scan/?url=http://juice-shop:3000&recurse=true&inScopeOnly=false&scanPolicyName=&method=&postData=&contextId=' | jq -r '.scan')
              echo \"Active Scan ID: \$ASCAN\"
              
              TIMEOUT=0
              while [ \$TIMEOUT -lt 9000 ]; do
                STATUS=\$(curl -s \"http://localhost:8080/JSON/ascan/view/status/?scanId=\$ASCAN\" | jq -r '.status')
                ALERTS=\$(curl -s 'http://localhost:8080/JSON/core/view/numberOfAlerts/' | jq -r '.numberOfAlerts')
                echo \"Active scan: \$STATUS% | Total Alerts: \$ALERTS\"
                [ \"\$STATUS\" = \"100\" ] && break
                sleep 20
                TIMEOUT=\$((TIMEOUT + 20))
              done
              
              FINAL=\$(curl -s 'http://localhost:8080/JSON/core/view/numberOfAlerts/' | jq -r '.numberOfAlerts')
              echo \"\"
              echo \"â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\"
              echo \"â•‘  ğŸ¯ TOTAL FINDINGS: \$FINAL\"
              echo \"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\"
              
              curl -s 'http://localhost:8080/OTHER/core/other/xmlreport/' -o /zap/wrk/zap.xml
              curl -s 'http://localhost:8080/OTHER/core/other/htmlreport/' -o /zap/wrk/zap.html
              curl -s 'http://localhost:8080/OTHER/core/other/jsonreport/' -o /zap/wrk/zap.json
            "
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap.xml
            zap.html
            zap.json
        if: always()
      - name: Detailed Summary
        run: |
          if [ -f zap.xml ]; then
            TOTAL=$(grep -c '<alertitem>' zap.xml || echo "0")
            HIGH=$(grep -c '<riskcode>3</riskcode>' zap.xml || echo "0")
            MEDIUM=$(grep -c '<riskcode>2</riskcode>' zap.xml || echo "0")
            LOW=$(grep -c '<riskcode>1</riskcode>' zap.xml || echo "0")
            INFO=$(grep -c '<riskcode>0</riskcode>' zap.xml || echo "0")
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ğŸ”’ ZAP ULTRA RESULTS              â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ¯ Total: $TOTAL"
            echo "ğŸ”´ High: $HIGH"
            echo "ğŸŸ  Medium: $MEDIUM"
            echo "ğŸŸ¡ Low: $LOW"
            echo "ğŸ”µ Info: $INFO"
          fi
        if: always()
      - name: Cleanup
        if: always()
        run: |
          docker stop juice-shop || true
          docker rm juice-shop || true
          docker network rm zap-net || true

  dast-nuclei:
    name: DAST - Nuclei (All Templates)
    needs: sast-semgrep-ultra
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Juice Shop
        run: |
          docker run -d --name juice-shop -p 3000:3000 ${{ env.JUICE_SHOP_IMAGE }}
          sleep 60
      - name: Run Nuclei (All Severity Levels)
        uses: projectdiscovery/nuclei-action@v3
        with:
          target: http://localhost:3000
          output: nuclei-results.txt
        continue-on-error: true
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-report
          path: nuclei-results.txt
        if: always()
      - name: Cleanup
        if: always()
        run: docker stop juice-shop && docker rm juice-shop || true

# =========================
# 5ï¸âƒ£ DEFECTDOJO UPLOAD
# =========================
  defectdojo:
    name: Upload to DefectDojo
    needs: [sast-semgrep-ultra, sast-nodejsscan, dast-zap-ultra, sca-dependency-check, sca-trivy, sca-npm-audit]
    runs-on: ubuntu-latest
    if: always()
    env:
      DD_URL: ${{ secrets.DEFECTDOJO_URL }}
      DD_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports
      
      - name: Upload Semgrep
        continue-on-error: true
        run: |
          if [ -f reports/semgrep-report/semgrep.json ]; then
            curl -v -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_KEY" \
              -F "scan_type=Semgrep JSON Report" \
              -F "file=@reports/semgrep-report/semgrep.json" \
              -F "product_name=DevSecOps_Project" \
              -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
              -F "test_title=Semgrep SAST (ULTRA)" \
              -F "auto_create_context=true" \
              -F "active=true" \
              -F "verified=false" 2>&1 | tee semgrep.log
            grep -q '"id":' semgrep.log && echo "âœ… Semgrep" || echo "âŒ Semgrep"
          fi
      
      - name: Upload ZAP
        continue-on-error: true
        run: |
          if [ -f reports/zap-reports/zap.xml ]; then
            curl -v -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_KEY" \
              -F "scan_type=ZAP Scan" \
              -F "file=@reports/zap-reports/zap.xml" \
              -F "product_name=DevSecOps_Project" \
              -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
              -F "test_title=ZAP DAST (ULTRA AGGRESSIVE)" \
              -F "auto_create_context=true" \
              -F "active=true" \
              -F "verified=false" 2>&1 | tee zap.log
            grep -q '"id":' zap.log && echo "âœ… ZAP" || echo "âŒ ZAP"
          fi
      
      - name: Upload Trivy
        continue-on-error: true
        run: |
          if [ -f reports/trivy-report/trivy-results.json ]; then
            curl -v -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_KEY" \
              -F "scan_type=Trivy Scan" \
              -F "file=@reports/trivy-report/trivy-results.json" \
              -F "product_name=DevSecOps_Project" \
              -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
              -F "test_title=Trivy SCA (All Scanners)" \
              -F "auto_create_context=true" \
              -F "active=true" \
              -F "verified=false" 2>&1 | tee trivy.log
            grep -q '"id":' trivy.log && echo "âœ… Trivy" || echo "âŒ Trivy"
          fi
      
      - name: Upload Dependency Check
        continue-on-error: true
        run: |
          if [ -f reports/dependency-check-report/dependency-check-report.xml ]; then
            curl -v -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_KEY" \
              -F "scan_type=Dependency Check Scan" \
              -F "file=@reports/dependency-check-report/dependency-check-report.xml" \
              -F "product_name=DevSecOps_Project" \
              -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
              -F "test_title=Dependency Check (All Analyzers)" \
              -F "auto_create_context=true" \
              -F "active=true" \
              -F "verified=false" 2>&1 | tee depcheck.log
            grep -q '"id":' depcheck.log && echo "âœ… DepCheck" || echo "âŒ DepCheck"
          fi

# =========================
# 6ï¸âƒ£ FINAL SUMMARY
# =========================
  summary:
    name: ğŸ“Š ULTRA SCAN SUMMARY
    needs: defectdojo
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          path: reports
      - name: Generate Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”’ ULTRA AGGRESSIVE SECURITY SCAN RESULTS            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          TOTAL=0
          
          if [ -f reports/semgrep-report/semgrep.json ]; then
            S=$(python3 -c "import json; print(len(json.load(open('reports/semgrep-report/semgrep.json')).get('results',[])))" 2>/dev/null || echo "0")
            echo "ğŸ” Semgrep (ULTRA): $S findings"
            TOTAL=$((TOTAL + S))
          fi
          
          if [ -f reports/zap-reports/zap.xml ]; then
            Z=$(grep -c '<alertitem>' reports/zap-reports/zap.xml || echo "0")
            echo "ğŸŒ ZAP (ULTRA): $Z findings"
            TOTAL=$((TOTAL + Z))
          fi
          
          if [ -f reports/trivy-report/trivy-results.json ]; then
            T=$(jq '[.Results[]?.Vulnerabilities[]?]|length' reports/trivy-report/trivy-results.json 2>/dev/null || echo "0")
            echo "ğŸ“¦ Trivy (All Scanners): $T vulnerabilities"
            TOTAL=$((TOTAL + T))
          fi
          
          if [ -f reports/dependency-check-report/dependency-check-report.xml ]; then
            D=$(grep -c "<vulnerability>" reports/dependency-check-report/dependency-check-report.xml || echo "0")
            echo "ğŸ“¦ Dependency Check: $D vulnerabilities"
            TOTAL=$((TOTAL + D))
          fi
          
          if [ -f reports/npm-audit-report/npm-audit.json ]; then
            N=$(jq '.metadata.vulnerabilities | to_entries | map(.value) | add' reports/npm-audit-report/npm-audit.json 2>/dev/null || echo "0")
            echo "ğŸ“¦ NPM Audit: $N vulnerabilities"
            TOTAL=$((TOTAL + N))
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ¯ TOTAL FINDINGS: $TOTAL+"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸš€ Target: 500-1000+ findings"
          if [ $TOTAL -gt 500 ]; then
            echo "âœ… TARGET ACHIEVED!"
          else
            echo "âš ï¸  Consider running with even longer scan times"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
